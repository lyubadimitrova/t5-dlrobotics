import numpy as np
from matplotlib import pyplot as plt
from t5.experiment import *
import sys
traj = np.array([[ 0.        ,  0.        ],
               [ 0.09537354, -0.04877331],
               [ 0.23247074, -0.11887766],
               [ 0.381859  , -0.19525812],
               [ 0.52805378, -0.26999323],
               [ 0.66351233, -0.33922222],
               [ 0.78513415, -0.40135593],
               [ 0.8922338 , -0.45604214],
               [ 0.98537638, -0.50357174],
               [ 1.06571704, -0.54454065],
               [ 1.1346338 , -0.57966028],
               [ 1.19352991, -0.60965468],
               [ 1.24373347, -0.6352082 ],
               [ 1.28645198, -0.65694194],
               [ 1.32275707, -0.67540602],
               [ 1.3535854 , -0.69108035],
               [ 1.37974747, -0.70437939],
               [ 1.40193988, -0.7156587 ],
               [ 1.42075867, -0.72522198],
               [ 1.4367125 , -0.73332813],
               [ 1.45023479, -0.74019778],
               [ 1.46169458, -0.74601885],
               [ 1.47140569, -0.7509513 ],
               [ 1.47963471, -0.75513101],
               [ 1.48660785, -0.75867327],
               [ 1.4925169 , -0.76167574],
               [ 1.49752437, -0.7642211 ],
               [ 1.50176794, -0.76637934],
               [ 1.50536414, -0.76820969],
               [ 1.50841158, -0.7697623 ],
               [ 1.51099368, -0.77107965],
               [ 1.51318106, -0.77219769],
               [ 1.51503373, -0.77314686],
               [ 1.51660276, -0.77395286],
               [ 1.51793169, -0.77463745],
               [ 1.51905754, -0.77521903],
               [ 1.52001175, -0.77571322],
               [ 1.52082093, -0.77613322],
               [ 1.52150756, -0.77649027],
               [ 1.5220906 , -0.77679389],
               [ 1.52258606, -0.77705216],
               [ 1.52300737, -0.77727191],
               [ 1.52336586, -0.77745897],
               [ 1.52367102, -0.77761825],
               [ 1.52393089, -0.77775392],
               [ 1.52415219, -0.77786952],
               [ 1.52434065, -0.77796806],
               [ 1.5245011 , -0.77805207],
               [ 1.52463765, -0.77812374],
               [ 1.52475379, -0.77818488]])
vel = np.array([[ 0.00000000e+00,  0.00000000e+00],
       [ 4.76867713e+00, -2.43866531e+00],
       [ 6.85486009e+00, -3.50521774e+00],
       [ 7.46941260e+00, -3.81902307e+00],
       [ 7.30973925e+00, -3.73675530e+00],
       [ 6.77292725e+00, -3.46144937e+00],
       [ 6.08109094e+00, -3.10668565e+00],
       [ 5.35498253e+00, -2.73431067e+00],
       [ 4.65712898e+00, -2.37647992e+00],
       [ 4.01703342e+00, -2.04844550e+00],
       [ 3.44583801e+00, -1.75598127e+00],
       [ 2.94480522e+00, -1.49971999e+00],
       [ 2.51017815e+00, -1.27767641e+00],
       [ 2.13592526e+00, -1.08668674e+00],
       [ 1.81525445e+00, -9.23203924e-01],
       [ 1.54141660e+00, -7.83716422e-01],
       [ 1.30810351e+00, -6.64952180e-01],
       [ 1.10962053e+00, -5.63965357e-01],
       [ 9.40939753e-01, -4.78164006e-01],
       [ 7.97691071e-01, -4.05307792e-01],
       [ 6.76114767e-01, -3.43482187e-01],
       [ 5.72989418e-01, -2.91053654e-01],
       [ 4.85555693e-01, -2.46622373e-01],
       [ 4.11451103e-01, -2.08985860e-01],
       [ 3.48656831e-01, -1.77113053e-01],
       [ 2.95452183e-01, -1.50123438e-01],
       [ 2.50373749e-01, -1.27268062e-01],
       [ 2.12178385e-01, -1.07911841e-01],
       [ 1.79810160e-01, -9.15174110e-02],
       [ 1.52372177e-01, -7.76306149e-02],
       [ 1.29104689e-01, -6.58674186e-02],
       [ 1.09369157e-01, -5.59021892e-02],
       [ 9.26332039e-02, -4.74580704e-02],
       [ 7.84515844e-02, -4.03000102e-02],
       [ 6.64464199e-02, -3.42294585e-02],
       [ 5.62928354e-02, -2.90793534e-02],
       [ 4.77106033e-02, -2.47091514e-02],
       [ 4.04588075e-02, -2.10003270e-02],
       [ 3.43313119e-02, -1.78526135e-02],
       [ 2.91524023e-02, -1.51809733e-02],
       [ 2.47727122e-02, -1.29131744e-02],
       [ 2.10656226e-02, -1.09878343e-02],
       [ 1.79241802e-02, -9.35281595e-03],
       [ 1.52584416e-02, -7.96388581e-03],
       [ 1.29931143e-02, -6.78356679e-03],
       [ 1.10653996e-02, -5.78014316e-03],
       [ 9.42301457e-03, -4.92679269e-03],
       [ 8.02241205e-03, -4.20083303e-03],
       [ 6.82722974e-03, -3.58307359e-03],
       [ 5.80698282e-03, -3.05726434e-03]])

def dmpplot(t, values, title):
    fig = plt.figure()
    l = len(values[0])
    for k in range(l):
        plt.figure(fig.number)
        plt.subplot(l, 1, k + 1)
        plt.plot(t, values[:len(t), k])
    plt.title(title)
    plt.savefig('misc/images/{}.png'.format(title))
    plt.close()

def plot_joint_pos_traj(joint_num, ps, ds, exp):
    fig = plt.figure()
    for i, (p, d) in enumerate(product(ps, ds)):

        acs = []
        env = exp.env.env_fns[0]()
        env.policy.p_gains = p
        env.policy.d_gains = d

        env.reset()

        for t, v in enumerate(zip(traj, vel)):
            ac = env.policy.get_action(v[0], v[1])
            acs.append(ac)
            obs, rew, done, info = env.step(ac)

        # print(env)
        qpos = np.array(env.qposs)
        # print(qpos.shape)
        # print(traj.shape)
        # plt.figure(fig.number)

        # plt.plot(traj)
        # plt.show()
        sp = plt.subplot(len(ps), len(ds), i + 1)
        sp.set_title("p={}, d={}".format(env.policy.p_gains, env.policy.d_gains), fontsize=10, y=0.7)
        plt.plot(qpos[1:, 1], label='qpos')
        plt.plot(np.array(acs)[:, 1], label='actions')
        plt.plot(traj[:, 1], label='trajectory')
    plt.legend()
    plt.savefig('misc/comp/all_joint{}.png'.format(joint_num))
    plt.show()

if __name__ == "__main__":
    from itertools import product

    plt.rcParams.update({'axes.labelsize': 'small'})
    exp = Experiment('configs/reacher_cma.yml')

    #ps = [200, 150, 100, 75, 50, 25, 10, 5]
    ps = [0.1, 0.2, 0.3, 1]
    #ds = [200, 150, 100, 75, 50, 25, 10, 5]
    ds = [0.1, 0.01]

    plot_joint_pos_traj(0, ps, ds, exp)
    plot_joint_pos_traj(1, ps, ds, exp)